BOOTLOADER_BINARIES := $(BINARIES)/boot
STAGE_1_SOURCES := $(BOOTLOADER_SOURCES_PATH)/bootloader_stage_1.asm
STAGE_2_SOURCES := $(BOOTLOADER_SOURCES_PATH)/bootloader_stage_2.asm
AP_BOOT_SOURCES := $(BOOTLOADER_SOURCES_PATH)/ap_boot.asm
BOOTLOADER_SOURCES := $(STAGE_1_SOURCES) \
			$(STAGE_2_SOURCES) \
			$(AP_BOOT_SOURCES)
STAGE_BINARIES := $(patsubst $(BOOTLOADER_SOURCES_PATH)/%,$(BOOTLOADER_BINARIES)/%,$(BOOTLOADER_SOURCES:.asm=.bin))
FINAL_BOOTLOADER := $(BOOTLOADER_BINARIES)/bootloader.bin
FLAGS := -fbin
AS := nasm

all: $(FINAL_BOOTLOADER)

$(FINAL_BOOTLOADER): $(STAGE_BINARIES)
	rm -f $@
	dd if=$< >> $@
	dd if=$(word 2, $^) >> $@
	dd if=$(word 3, $^) >> $@

$(BOOTLOADER_BINARIES)/%.bin: $(BOOTLOADER_SOURCES_PATH)/%.asm
	$(AS) $(FLAGS) $< -o $@

.PHONY: clean

clean:
	rm -f $(STAGE_1_BOOTLOADER) $(STAGE_2_BOOTLOADER) $(FINAL_BOOTLOADER)
